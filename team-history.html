<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynasty FFL Team History</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <h1>Dynasty FFL Team History</h1>
    <div id="menu-bar"></div>
    <script>
        fetch('menu.html')
            .then(r => r.text())
            .then(html => document.getElementById('menu-bar').outerHTML = html);
    </script>
    <div class="section" id="history-container">Loading...</div>
    <script>
        function getTeamNumberFromQuery() {
            const params = new URLSearchParams(window.location.search);
            return params.get('team');
        }

        const teamsCsvPath = '../data/Dynasty League Data - Teams.csv';
        const ownersCsvPath = '../data/Dynasty League Data - Owners.csv';
        const scheduleCsvPath = '../data/Dynasty League Data - Schedule.csv';

        function getLatestTeamInfo(teamsData, teamNum) {
            const filtered = teamsData.filter(row => row[1] === teamNum);
            if (filtered.length === 0) return null;
            return filtered.reduce((latest, row) => {
                return parseInt(row[0]) > parseInt(latest[0]) ? row : latest;
            }, filtered[0]);
        }

        function getTeamNameHistory(teamsData, teamNum) {
            return teamsData
                .filter(row => row[1] === teamNum)
                .map(row => ({ year: parseInt(row[0]), name: row[2] }))
                .sort((a, b) => b.year - a.year);
        }

        function renderTeamSchedule(schedule, teamNames, filterWeek = '', filterYear = '', filterOpponent = '') {
            if (!schedule.length) return '';
            let html = `
            <div class="filters" style="margin-bottom:1em;">
                <label>Year:
                    <select id="filter-year"><option value="">All</option></select>
                </label>
                <label>Week:
                    <select id="filter-week"><option value="">All</option></select>
                </label>
                <label>Opponent:
                    <select id="filter-opponent"><option value="">All</option></select>
                </label>
                <button id="clear-schedule-filters" type="button">Clear</button>
            </div>
            <div style="margin:1em 0;">
            <strong>Team Schedule:</strong>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Week</th>
                        <th>Opponent</th>
                        <th>Home/Away</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // Gather filter options
            const years = new Set(), weeks = new Set(), opponents = new Set();
            schedule.forEach(game => {
                let isHome = teamNames.includes(game[3]);
                let isAway = teamNames.includes(game[4]);
                if (!isHome && !isAway) return;
                years.add(game[0]);
                weeks.add(game[1]);
                opponents.add(isHome ? game[4] : game[3]);
            });

            // Filter schedule rows
            schedule.forEach(game => {
                let isHome = teamNames.includes(game[3]);
                let isAway = teamNames.includes(game[4]);
                if (!isHome && !isAway) return;
                const opponent = isHome ? game[4] : game[3];
                if (filterYear && game[0] !== filterYear) return;
                if (filterWeek && game[1] !== filterWeek) return;
                if (filterOpponent && opponent !== filterOpponent) return;
                html += `<tr>
                    <td>${game[0]}</td>
                    <td>${game[1]}</td>
                    <td>${opponent}</td>
                    <td>${isHome ? 'Home' : 'Away'}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;

            // Add filter options to selects after rendering
            setTimeout(() => {
                const yearSel = document.getElementById('filter-year');
                const weekSel = document.getElementById('filter-week');
                const oppSel = document.getElementById('filter-opponent');
                if (yearSel && weekSel && oppSel) {
                    [yearSel, weekSel, oppSel].forEach(sel => {
                        while (sel.options.length > 1) sel.remove(1);
                    });
                    Array.from(years).sort().forEach(y => {
                        const opt = document.createElement('option');
                        opt.value = y;
                        opt.textContent = y;
                        yearSel.appendChild(opt);
                    });
                    Array.from(weeks).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(w => {
                        const opt = document.createElement('option');
                        opt.value = w;
                        opt.textContent = w;
                        weekSel.appendChild(opt);
                    });
                    Array.from(opponents).sort().forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o;
                        opt.textContent = o;
                        oppSel.appendChild(opt);
                    });
                }
            }, 0);

            return html;
        }

        function renderTeamHistory(team, owners, nameHistory, schedule) {
            let html = `<a class="back-link" href="teams.html">&larr; Back to Teams</a>`;
            html += `<div class="team-history-card" style="max-width:500px;margin:2em auto 2em auto;padding:2em 2em 1em 2em;background:linear-gradient(135deg,#e3e8ee 0%,#f6f8fa 100%);border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,0.07);position:relative;">`;
            html += `<div class="team-number">${team[1]}</div>`;
            html += `<div class="team-history-content" style="display:flex;flex-direction:column;align-items:center;">`;
            if (team[3]) {
                html += `<div class="team-logo-wrap" style="width:90px;height:90px;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:50%;margin-bottom:1em;box-shadow:0 2px 8px rgba(0,188,212,0.07);">
                    <img class="team-logo" src="${team[3]}" alt="${team[2]} logo" style="width:70px;height:70px;object-fit:contain;border-radius:50%;background:#f6f8fa;" onerror="this.style.display='none'">
                </div>`;
            }
            html += `<h2 class="team-name" style="margin:0.5em 0 0.5em 0;font-size:1.15em;font-weight:700;color:#222;text-align:center;letter-spacing:0.5px;">${team[2]}</h2>`;

            const currentOwner = owners.length > 0
                ? owners.slice().sort((a, b) => b.year - a.year)[0].owner
                : '';
            html += `<div class="team-owner" style="margin-top:0.5em;font-size:1em;color:#333;text-align:center;background:#e0f7fa;border-radius:6px;padding:0.4em 0.8em;display:inline-block;">
                        <span class="owner-label" style="font-weight:500;color:#0097a7;margin-right:0.3em;">Owner:</span>
                        <span class="owner-name" style="font-weight:700;color:#222;">${currentOwner}</span>
                    </div>`;

            // Team Name History
            if (nameHistory.length > 1) {
                html += `<div style="margin:1em 0;"><strong>Team Name History:</strong><ul style="margin:0.5em 0 0 1.5em;">`;
                nameHistory.forEach(entry => {
                    html += `<li>${entry.year}: ${entry.name}</li>`;
                });
                html += `</ul></div>`;
            }

            // Owner History
            html += `<div style="margin:1em 0;"><strong>Owner History:</strong><ul style="margin:0.5em 0 0 1.5em;">`;
            if (owners.length > 0) {
                owners = owners.slice().sort((a, b) => b.year - a.year);
                for (let i = 0; i < owners.length; i++) {
                    const startYear = owners[i].year;
                    let endYear;
                    if (i > 0) {
                        endYear = owners[i - 1].year;
                    } else {
                        endYear = (owners[i].owner === currentOwner) ? "Present" : "";
                    }
                    html += `<li>${owners[i].owner}: ${startYear} - ${endYear}</li>`;
                }
            } else {
                html += `<li>No owner data</li>`;
            }
            html += `</ul></div>`;

            html += `</div>`; // .team-history-content

            // Team Schedule with filters
            let filterYear = '', filterWeek = '', filterOpponent = '';
            function renderScheduleTable() {
                document.getElementById('team-schedule-container').innerHTML =
                    renderTeamSchedule(schedule, nameHistory.map(n => n.name), filterWeek, filterYear, filterOpponent);
                setTimeout(() => {
                    const yearSel = document.getElementById('filter-year');
                    const weekSel = document.getElementById('filter-week');
                    const oppSel = document.getElementById('filter-opponent');
                    const clearBtn = document.getElementById('clear-schedule-filters');
                    if (yearSel) yearSel.value = filterYear;
                    if (weekSel) weekSel.value = filterWeek;
                    if (oppSel) oppSel.value = filterOpponent;
                    if (yearSel) yearSel.onchange = function() { filterYear = this.value; renderScheduleTable(); };
                    if (weekSel) weekSel.onchange = function() { filterWeek = this.value; renderScheduleTable(); };
                    if (oppSel) oppSel.onchange = function() { filterOpponent = this.value; renderScheduleTable(); };
                    if (clearBtn) clearBtn.onclick = function() {
                        filterYear = ''; filterWeek = ''; filterOpponent = '';
                        renderScheduleTable();
                    };
                }, 0);
            }

            html += `<div id="team-schedule-container"></div>`;
            document.getElementById('history-container').innerHTML = html;
            renderScheduleTable();
        }

        // Load all CSVs and render
        Promise.all([
            fetch(teamsCsvPath).then(r => r.text()),
            fetch(ownersCsvPath).then(r => r.text()),
            fetch(scheduleCsvPath).then(r => r.text())
        ]).then(([teamsCsv, ownersCsv, scheduleCsv]) => {
            Papa.parse(teamsCsv, {
                header: false,
                skipEmptyLines: true,
                complete: function(teamsResults) {
                    Papa.parse(ownersCsv, {
                        header: false,
                        skipEmptyLines: true,
                        complete: function(ownersResults) {
                            Papa.parse(scheduleCsv, {
                                header: false,
                                skipEmptyLines: true,
                                complete: function(scheduleResults) {
                                    const teamsData = teamsResults.data.filter(row =>
                                        row[0] && !row[0].startsWith('//') && row[0] !== 'Year'
                                    );
                                    const ownersData = ownersResults.data.filter(row =>
                                        row[0] && !row[0].startsWith('//') && row[0] !== 'Year'
                                    );
                                    const scheduleData = scheduleResults.data.filter(row =>
                                        row[0] && !row[0].startsWith('//') && row[0] !== 'Year'
                                    );
                                    const teamNum = getTeamNumberFromQuery();

                                    if (!teamNum) {
                                        // No team selected, show dropdown
                                        let html = `<div class="section"><h2>Select a Team</h2><select id="select-team"><option value="">-- Select Team --</option>`;
                                        // Only show latest team names for each team number
                                        const latestTeams = {};
                                        teamsData.forEach(row => {
                                            const year = parseInt(row[0]);
                                            const num = row[1];
                                            if (!latestTeams[num] || year > parseInt(latestTeams[num][0])) {
                                                latestTeams[num] = row;
                                            }
                                        });
                                        Object.values(latestTeams).sort((a, b) => parseInt(a[1]) - parseInt(b[1])).forEach(row => {
                                            html += `<option value="${row[1]}">${row[2]}</option>`;
                                        });
                                        html += `</select></div>`;
                                        document.getElementById('history-container').innerHTML = html;
                                        document.getElementById('select-team').addEventListener('change', function() {
                                            if (this.value) {
                                                window.location.search = '?team=' + encodeURIComponent(this.value);
                                            }
                                        });
                                        return;
                                    }

                                    const team = getLatestTeamInfo(teamsData, teamNum);
                                    const nameHistory = getTeamNameHistory(teamsData, teamNum);
                                    const teamOwners = ownersData
                                        .filter(row => row[1] === teamNum)
                                        .map(row => ({ year: parseInt(row[0]), owner: row[2] }))
                                        .sort((a, b) => a.year - b.year);

                                    const allNames = nameHistory.map(n => n.name);
                                    const teamSchedule = scheduleData.filter(row =>
                                        allNames.includes(row[3]) || allNames.includes(row[4])
                                    );

                                    if (team) {
                                        renderTeamHistory(team, teamOwners, nameHistory, teamSchedule);
                                    } else {
                                        document.getElementById('history-container').innerHTML = 'Team not found.';
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }).catch(() => {
            document.getElementById('history-container').innerText = 'Failed to load team history data.';
        });
    </script>
</body>
</html>