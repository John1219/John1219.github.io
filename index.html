<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Weekly Predictions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Stadium Night -->
    <!-- Application Structure Plan: The application is designed as a single-page dashboard with two primary, switchable views: "This Week's Predictions" and "Past Weeks' Results". This structure was chosen to provide users with a clear, focused experience. The default view immediately presents the most current and relevant information (this week's games) using a visually scannable card layout. Detailed game analysis is hidden by default within modals, which are triggered by a "View Analysis" button on each card. This prevents information overload and allows users to optionally drill down into specifics without leaving the main view. The secondary view for past results uses a similar card layout for consistency and is controlled by a simple dropdown, making historical exploration intuitive. This separation of current vs. past and summary vs. detail creates a logical user flow that prioritizes ease of navigation and quick information absorption. A hidden admin panel, accessible via a URL parameter, allows for easy data updates and week rollovers using Firestore as the backend. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Team matchups, predicted scores, and spreads. -> Goal: Inform/Compare -> Presentation: HTML/CSS Game Cards with official team logos. -> Interaction: None. -> Justification: Cards are a standard, effective UI pattern for presenting discrete, comparable items. Using official logos enhances visual appeal and team recognition. -> Method: Tailwind CSS, IMG tags.
        - Report Info: Detailed game-by-game breakdown text. -> Goal: Inform (Detailed) -> Presentation: Text block inside a modal window. -> Interaction: Click "View Analysis" button to open, "Close" button to dismiss. -> Justification: Modals provide detailed context on-demand without disrupting the layout of the main page, focusing the user's attention. -> Method: Vanilla JS.
        - Report Info: All game predictions for the week. -> Goal: Organize/Explore -> Presentation: Interactive Navigation Tabs/Buttons ("This Week", "Past Weeks"). -> Interaction: Click to switch between the main content views. -> Justification: This is the core navigation for the SPA, allowing users to move between the two main content sections cleanly. -> Method: Vanilla JS.
        - Report Info: Historical game data (predicted vs. actual). -> Goal: Compare/Organize -> Presentation: Dropdown selector for week selection and dynamically rendered result cards. -> Interaction: Select a week from the dropdown to load its data. -> Justification: A dropdown is a space-efficient way to handle historical navigation with a potentially growing number of weeks. -> Method: Vanilla JS.
        - Report Info: Predicted score margin vs. consensus spread for each game. -> Goal: Compare/Analyze -> Presentation: Horizontal Bar Chart. -> Interaction: Hover for tooltips with specific values. -> Justification: A bar chart provides a powerful, at-a-glance visualization of performance against the spread, making it easy to see the biggest predicted upsets and safest bets. -> Library: Chart.js (Canvas).
        - Report Info: Week 6 Predictive Scorecard (Table 1). -> Goal: Summarize/Inform -> Presentation: Styled HTML Table. -> Interaction: None. -> Justification: A table is the most direct and clear way to present tabular data, providing a high-level summary before users explore individual game cards. -> Method: Tailwind CSS and dynamic JS rendering.
        - Data Management: -> Goal: Allow easy updates and archiving. -> Presentation: Hidden admin panel with a JSON editor. -> Interaction: Load current data, save updates, and "finalize week" to archive and create a new week. -> Justification: Separates data management from the display, enabling non-technical users to update content. Firestore provides a scalable and real-time backend. -> Method: Firebase Firestore, Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal, .admin-view {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .nav-active {
            background-color: #4f46e5 !important;
            color: white !important;
        }
        #admin-json-editor {
            font-family: 'Courier New', Courier, monospace;
            min-height: 400px;
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200">

    <header class="bg-gray-800 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-black text-white tracking-wider mb-4 sm:mb-0">
                <span class="text-indigo-400">NFL</span> FORECAST
            </h1>
            <nav id="main-nav" class="flex space-x-2 bg-gray-700 p-1 rounded-lg">
                <button data-view="predictions" class="nav-button nav-active px-4 py-2 text-sm font-semibold rounded-md transition-colors duration-200">This Week's Predictions</button>
                <button data-view="history" class="nav-button px-4 py-2 text-sm font-semibold rounded-md transition-colors duration-200 hover:bg-gray-600">Past Weeks' Results</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        
        <section id="admin-view" class="hidden mb-12 bg-gray-800 border border-indigo-500 rounded-xl p-6">
            <h2 class="text-3xl font-bold text-center text-indigo-400 mb-4">Admin Control Panel</h2>
            <div class="mb-4">
                <label for="admin-json-editor" class="block mb-2 text-sm font-medium text-gray-300">Current Week's Data (JSON)</label>
                <textarea id="admin-json-editor" class="w-full p-2.5 bg-gray-900 text-gray-200 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="save-week-data-btn" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Changes</button>
                <button id="finalize-week-btn" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Finalize Current Week & Advance</button>
            </div>
             <p class="text-center mt-4 text-xs text-yellow-400">Warning: Finalizing the week is irreversible and will create the next week's empty template.</p>
            <p id="admin-status" class="text-center mt-2 text-sm"></p>
        </section>


        <section id="predictions-view">
            <div class="text-center mb-8">
                <h2 id="prediction-week-title" class="text-4xl font-bold text-white">Loading Week...</h2>
                <p class="text-gray-400 mt-2 max-w-2xl mx-auto">Here are the analytical projections for the current matchups. Each prediction is based on a model synthesizing performance metrics, situational factors, and injury reports.</p>
            </div>

            <div id="summary-section" class="mb-12">
                 <div class="text-center mb-6">
                    <h3 id="scorecard-title" class="text-3xl font-bold text-white">Predictive Scorecard</h3>
                    <p class="text-gray-400 mt-2 max-w-2xl mx-auto">A quick overview of all projected matchups, spreads, and outcomes for the week.</p>
                </div>
                <div class="bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Matchup</th>
                                    <th scope="col" class="px-6 py-3">Time (ET)</th>
                                    <th scope="col" class="px-6 py-3">Consensus Spread</th>
                                    <th scope="col" class="px-6 py-3 text-center">Predicted Score</th>
                                    <th scope="col" class="px-6 py-3 text-center">Outcome vs. Spread</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body" class="divide-y divide-gray-700">
                                <tr><td colspan="5" class="text-center p-8">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="game-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
            
            <div class="mt-12 bg-gray-800 p-6 rounded-xl shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-1 text-white">Predicted Margin vs. Spread</h3>
                 <p class="text-gray-400 mt-1 mb-6 text-center text-sm max-w-2xl mx-auto">This chart visualizes the predicted margin of victory for the winning team compared to the consensus betting spread. Bars extending further to the right indicate a stronger predicted performance against the spread.</p>
                <div class="chart-container relative w-full h-96 max-h-[500px] max-w-4xl mx-auto">
                    <canvas id="spread-chart"></canvas>
                </div>
            </div>
        </section>

        <section id="history-view" class="hidden">
             <div class="text-center mb-8">
                <h2 class="text-4xl font-bold text-white">Past Weeks' Results</h2>
                 <p class="text-gray-400 mt-2 max-w-2xl mx-auto">Review the prediction accuracy from previous weeks. Select a week below to see the projected scores versus the actual final scores for each game.</p>
            </div>
            <div class="flex justify-center mb-6">
                <select id="week-selector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full max-w-xs p-2.5">
                    <option>Loading past weeks...</option>
                </select>
            </div>
            <div id="history-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
        </section>

    </main>
    
    <footer class="text-center py-6 mt-8 border-t border-gray-700">
        <p class="text-gray-500 text-sm">&copy; 2025 NFL Forecast. All data is for entertainment purposes only.</p>
    </footer>

    <div id="analysis-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95">
            <div class="sticky top-0 bg-gray-800 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-white">Game Analysis</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6">
                <p id="modal-body" class="text-gray-300 leading-relaxed"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            doc, 
            writeBatch,
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const teamData = {
            'Philadelphia Eagles': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/phi.png' },
            'New York Giants': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png' },
            'Denver Broncos': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/den.png' },
            'New York Jets': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png' },
            'Los Angeles Rams': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/lar.png' },
            'Baltimore Ravens': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/bal.png' },
            'Atlanta Falcons': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/atl.png' },
            'Buffalo Bills': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/buf.png' },
            'Washington Commanders': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png' },
            'Chicago Bears': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/chi.png' },
            'Kansas City Chiefs': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/kc.png' },
            'Las Vegas Raiders': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/lv.png' },
            'Dallas Cowboys': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/dal.png' },
            'Tampa Bay Buccaneers': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/tb.png' },
            'Houston Texans': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/hou.png' },
            'Green Bay Packers': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/gb.png' },
            'Indianapolis Colts': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/ind.png' },
            'Jacksonville Jaguars': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/jax.png' },
            'Miami Dolphins': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/mia.png' },
            'Minnesota Vikings': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/min.png' },
            'New England Patriots': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/ne.png' },
            'Cleveland Browns': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/cle.png' },
            'Pittsburgh Steelers': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/pit.png' },
            'Cincinnati Bengals': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/cin.png' },
            'San Francisco 49ers': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/sf.png' },
            'Seattle Seahawks': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/sea.png' },
            'Arizona Cardinals': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/ari.png' },
            'Detroit Lions': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/det.png' },
            'Carolina Panthers': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/car.png' },
            'Los Angeles Chargers': { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/lac.png' },
        };
        
        let db;
        let auth;
        let spreadChart = null;
        let currentWeekData = null;
        let pastWeeksData = [];

        // UI Elements
        const gameCardsContainer = document.getElementById('game-cards-container');
        const summaryTableBody = document.getElementById('summary-table-body');
        const historyCardsContainer = document.getElementById('history-cards-container');
        const weekSelector = document.getElementById('week-selector');
        const mainNav = document.getElementById('main-nav');
        const views = {
            predictions: document.getElementById('predictions-view'),
            history: document.getElementById('history-view')
        };
        const modal = document.getElementById('analysis-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const predictionWeekTitle = document.getElementById('prediction-week-title');
        const scorecardTitle = document.getElementById('scorecard-title');

        // Admin UI Elements
        const adminView = document.getElementById('admin-view');
        const adminJsonEditor = document.getElementById('admin-json-editor');
        const saveWeekDataBtn = document.getElementById('save-week-data-btn');
        const finalizeWeekBtn = document.getElementById('finalize-week-btn');
        const adminStatus = document.getElementById('admin-status');

        const getTeamInfo = (name) => teamData[name] || { logo: 'https://a.espncdn.com/i/teamlogos/nfl/500/nfl.png' };

        const createGameCard = (game) => {
            const awayInfo = getTeamInfo(game.teams.away);
            const homeInfo = getTeamInfo(game.teams.home);
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col transition-transform transform hover:scale-105';
            
            card.innerHTML = `
                <div class="flex-grow">
                    <p class="text-xs text-center text-gray-400 mb-3">${game.time} | Spread: ${game.spread}</p>
                    <div class="flex justify-between items-center text-center">
                        <div class="flex-1 flex flex-col items-center">
                            <img src="${awayInfo.logo}" alt="${game.teams.away} logo" class="h-12 w-12 object-contain mb-2">
                            <span class="font-bold mt-2 text-sm">${game.teams.away}</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center">
                            <span class="text-4xl font-black text-gray-400">@</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center">
                            <img src="${homeInfo.logo}" alt="${game.teams.home} logo" class="h-12 w-12 object-contain mb-2">
                            <span class="font-bold mt-2 text-sm">${game.teams.home}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4 border-t-2 border-dashed border-gray-700 pt-4">
                         <div class="flex-1 text-center">
                            <span class="text-3xl font-bold text-indigo-400">${game.prediction.away}</span>
                        </div>
                        <div class="flex-1 text-center">
                            <span class="text-3xl font-bold text-indigo-400">${game.prediction.home}</span>
                        </div>
                    </div>
                </div>
                <button class="view-analysis-btn mt-4 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-500 transition-colors duration-200">View Analysis</button>
            `;
            card.querySelector('.view-analysis-btn').addEventListener('click', () => {
                modalTitle.textContent = `${game.teams.away} @ ${game.teams.home}`;
                modalBody.textContent = game.analysis;
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            });
            return card;
        };

        const createHistoryCard = (game) => {
            const predictedWinner = game.prediction.away > game.prediction.home ? 'away' : 'home';
            const actualWinner = game.actual.away > game.actual.home ? 'away' : 'home';
            const correctPick = predictedWinner === actualWinner;

            return `
                <div class="bg-gray-800 rounded-xl shadow-lg p-4 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                         <span class="text-sm font-semibold text-gray-300">${game.teams.away}</span>
                         <span class="text-sm font-semibold text-gray-300">${game.teams.home}</span>
                    </div>
                    <div class="bg-gray-700 rounded p-2 mb-2">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400">Predicted:</span>
                            <div>
                                <span class="font-bold ${predictedWinner === 'away' ? 'text-green-400' : ''}">${game.prediction.away}</span>
                                -
                                <span class="font-bold ${predictedWinner === 'home' ? 'text-green-400' : ''}">${game.prediction.home}</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-900 rounded p-2">
                         <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-400">Actual:</span>
                            <div>
                                <span class="font-bold ${actualWinner === 'away' ? 'text-white' : ''}">${game.actual.away}</span>
                                -
                                <span class="font-bold ${actualWinner === 'home' ? 'text-white' : ''}">${game.actual.home}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-center text-xs font-bold py-1 rounded ${correctPick ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                        ${correctPick ? 'CORRECT PICK' : 'INCORRECT PICK'}
                    </div>
                </div>
            `;
        };

        const renderSummaryTable = (games = []) => {
            summaryTableBody.innerHTML = '';
            if (games.length === 0) {
                summaryTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8">No game data for this week.</td></tr>`;
                return;
            }
            games.forEach(game => {
                const outcomeText = game.outcomeVsSpread || 'N/A';
                const isCover = outcomeText.toLowerCase().includes('cover');
                const outcomeColorClass = isCover ? 'bg-green-500/20 text-green-300' : 'bg-yellow-500/20 text-yellow-300';
                const outcomeBadge = `<span class="px-2 py-1 font-semibold text-xs rounded-full ${outcomeColorClass}">${outcomeText}</span>`;

                const row = `
                    <tr class="bg-gray-800 hover:bg-gray-700/50">
                        <td class="px-6 py-4 font-medium text-white">${game.teams.away} @ ${game.teams.home}</td>
                        <td class="px-6 py-4">${game.time}</td>
                        <td class="px-6 py-4">${game.spread}</td>
                        <td class="px-6 py-4 text-center font-mono tracking-wider">${game.prediction.away} - ${game.prediction.home}</td>
                        <td class="px-6 py-4 text-center">${outcomeBadge}</td>
                    </tr>
                `;
                summaryTableBody.innerHTML += row;
            });
        };
        
        const renderPredictions = (week) => {
            currentWeekData = week;
            const games = week.games || [];
            gameCardsContainer.innerHTML = '';
            predictionWeekTitle.textContent = `Week ${week.weekNumber} Predictions`;
            scorecardTitle.textContent = `Week ${week.weekNumber} Predictive Scorecard`;
            
            if (games.length === 0) {
                gameCardsContainer.innerHTML = `<p class="md:col-span-2 lg:col-span-3 text-center">No games scheduled for this week yet.</p>`;
            } else {
                games.forEach(game => {
                    gameCardsContainer.appendChild(createGameCard(game));
                });
            }
            
            renderSummaryTable(games);
            renderSpreadChart(games);
            
            if (adminView.classList.contains('hidden') === false) {
                adminJsonEditor.value = JSON.stringify(games, null, 2);
            }
        };

        const renderHistoryView = (selectedWeek) => {
            historyCardsContainer.innerHTML = '';
            const weekData = pastWeeksData.find(w => w.weekNumber == selectedWeek);
            const games = weekData ? weekData.games : [];

            if (games.length > 0) {
                games.forEach(game => {
                    historyCardsContainer.innerHTML += createHistoryCard(game);
                });
            } else {
                historyCardsContainer.innerHTML = `<p class="md:col-span-2 lg:col-span-3 text-center">No results available for this week.</p>`;
            }
        };

        const populateWeekSelector = () => {
            weekSelector.innerHTML = '';
            if (pastWeeksData.length === 0) {
                weekSelector.innerHTML = `<option>No past weeks available</option>`;
                return;
            }
            pastWeeksData.sort((a, b) => b.weekNumber - a.weekNumber);
            pastWeeksData.forEach(week => {
                const option = document.createElement('option');
                option.value = week.weekNumber;
                option.textContent = `Week ${week.weekNumber}`;
                weekSelector.appendChild(option);
            });
            if(weekSelector.value) {
                renderHistoryView(weekSelector.value);
            }
        };
        
        const renderSpreadChart = (games = []) => {
            const ctx = document.getElementById('spread-chart').getContext('2d');
            if (spreadChart) {
                spreadChart.destroy();
            }
            if (games.length === 0) {
                return;
            }

            const chartData = games.map(game => {
                const spreadMatch = game.spread.match(/([A-Za-z\s.'-]+) (-?\d+\.?\d*)/);
                if (!spreadMatch) return { label: '', value: 0, color: '#4f46e5' };

                const favTeam = spreadMatch[1].trim();
                const spreadValue = parseFloat(spreadMatch[2]);
                
                const isAwayFav = game.teams.away.includes(favTeam);
                const homeSpread = isAwayFav ? -spreadValue : spreadValue;
                
                const predictedMargin = game.prediction.home - game.prediction.away;
                const marginVsSpread = predictedMargin - homeSpread;
                
                const predictedWinner = game.prediction.home > game.prediction.away ? game.teams.home : game.teams.away;
                
                return {
                    label: `${game.teams.away} @ ${game.teams.home}`,
                    value: game.prediction.home > game.prediction.away ? predictedMargin + homeSpread : -predictedMargin - homeSpread,
                    color: marginVsSpread > 0 ? '#10B981' : '#EF4444',
                    winner: predictedWinner
                };
            }).sort((a, b) => b.value - a.value);

            spreadChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.label),
                    datasets: [{
                        label: 'Predicted Margin vs. Spread',
                        data: chartData.map(d => d.value),
                        backgroundColor: chartData.map(d => d.color),
                        borderColor: chartData.map(d => d.color.replace(')', ', 0.5)').replace('rgb', 'rgba')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9CA3AF', font: { weight: 'bold' } } },
                        y: { grid: { display: false }, ticks: { color: '#D1D5DB', font: { size: 10 } } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => `${chartData[context.dataIndex].winner} predicted to cover by ${context.raw.toFixed(1)} points.` } }
                    }
                }
            });
        };

        const setupEventListeners = () => {
            mainNav.addEventListener('click', (e) => {
                if (e.target.classList.contains('nav-button')) {
                    const view = e.target.dataset.view;
                    Object.values(views).forEach(v => v.classList.add('hidden'));
                    views[view].classList.remove('hidden');
                    mainNav.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('nav-active'));
                    e.target.classList.add('nav-active');
                }
            });

            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-content').classList.add('scale-95');
            });
            modal.addEventListener('click', (e) => { e.target === modal && closeModalBtn.click(); });

            weekSelector.addEventListener('change', (e) => renderHistoryView(e.target.value));
        };
        
        const setupAdminPanel = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('admin') === 'true') {
                adminView.classList.remove('hidden');
            }

            saveWeekDataBtn.addEventListener('click', async () => {
                adminStatus.textContent = 'Saving...';
                try {
                    const updatedGames = JSON.parse(adminJsonEditor.value);
                    const weekDocRef = doc(db, "nfl_predictions", currentWeekData.id);
                    await setDoc(weekDocRef, { games: updatedGames }, { merge: true });
                    adminStatus.textContent = 'Successfully saved!';
                } catch (error) {
                    console.error("Error saving data:", error);
                    adminStatus.textContent = `Error saving: ${error.message}`;
                }
                setTimeout(() => adminStatus.textContent = '', 3000);
            });

            finalizeWeekBtn.addEventListener('click', async () => {
                adminStatus.textContent = 'Finalizing...';
                try {
                    const batch = writeBatch(db);
                    const currentWeekDocRef = doc(db, "nfl_predictions", currentWeekData.id);
                    batch.update(currentWeekDocRef, { status: "past" });

                    const nextWeekNumber = currentWeekData.weekNumber + 1;
                    const nextWeekDocRef = doc(db, "nfl_predictions", `week_${nextWeekNumber}`);
                    const newWeekData = {
                        weekNumber: nextWeekNumber,
                        status: "current",
                        games: [] 
                    };
                    batch.set(nextWeekDocRef, newWeekData);
                    
                    await batch.commit();
                    adminStatus.textContent = `Week ${currentWeekData.weekNumber} finalized. Week ${nextWeekNumber} is now active.`;
                } catch (error) {
                    console.error("Error finalizing week:", error);
                    adminStatus.textContent = `Error: ${error.message}`;
                }
                 setTimeout(() => adminStatus.textContent = '', 5000);
            });
        };

        async function initializeAppWithFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyCwnT6_QfL4VV9fDds5XYTw1vi5hb9PpgY",
                  authDomain: "predictions-app-2c969.firebaseapp.com",
                  projectId: "predictions-app-2c969",
                  storageBucket: "predictions-app-2c969.firebasestorage.app",
                  messagingSenderId: "668969527921",
                  appId: "1:668969527921:web:6ade6334bb67d03b57c9d0",
                  measurementId: "G-YMDTQSY8GS"
                };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                console.log("Firebase initialized and user signed in.");

                const predictionsCollection = collection(db, "nfl_predictions");

                const qCurrent = query(predictionsCollection, where("status", "==", "current"));
                onSnapshot(qCurrent, (snapshot) => {
                    if (snapshot.empty) {
                        console.log("No current week found.");
                        renderPredictions({ weekNumber: 'N/A', games: [] });
                    } else {
                        const doc = snapshot.docs[0];
                        renderPredictions({ id: doc.id, ...doc.data() });
                    }
                });

                const qPast = query(predictionsCollection, where("status", "==", "past"));
                onSnapshot(qPast, (snapshot) => {
                    pastWeeksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateWeekSelector();
                });
                
                setupEventListeners();
                setupAdminPanel();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('predictions-view').innerHTML = `<div class="text-center p-8 bg-red-900/50 border border-red-700 rounded-lg"><h3 class="font-bold text-red-300">Failed to Connect to Data Service</h3><p class="text-red-400 mt-2 text-sm">Please ensure your Firebase project is set up correctly, Authentication is enabled, and the security rules are published as per the instructions.</p></div>`;
            }
        }
        
        initializeAppWithFirebase();

    </script>
</body>
</html>

